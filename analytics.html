<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Analytics | AuthGuard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<nav class="navbar">
  <div class="nav-left">
    <div class="profile-circle">A</div>
    <span class="site-name">AuthGuard</span>
  </div>
  <div class="nav-right">
    <a href="index.html">Home</a>
    <a href="profile.html">Profile</a>
    <a href="login.html">Logout</a>
  </div>
</nav>

<section style="padding:120px 8%;">
  <h2>Analytics</h2>
  <div class="card">
    <canvas id="historyChart" style="height:280px;"></canvas>
  </div>

  <div style="margin-top:20px;" class="card">
    <h3>Combined Click Heatmap</h3>
    <canvas id="combinedHeat" width="900" height="280" style="width:100%;"></canvas>
  </div>
</section>

<script>
(async function loadAnalytics(){
  const username = sessionStorage.getItem('authguard_user');
  if (!username) return window.location.href = 'login.html';
  try {
    const res = await fetch('http://127.0.0.1:5000/admin');
    const data = await res.json();
    const user = data[username];
    if (!user || !user.history || !user.history.length) {
      document.querySelector('.card').innerHTML = '<div class="small">No history available yet.</div>';
      return;
    }
    const times = user.history.map(h => new Date(h.ts));
    const frauds = user.history.map(h => h.fraud);
    const flights = user.history.map(h => h.flight);
    const dwell = user.history.map(h => h.dwell);
    const touchSpeeds = user.history.map(h => h.touch_speed || 0);

    const ctx = document.getElementById('historyChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: times.map(t=>t.toLocaleTimeString()),
        datasets: [
          { label: 'Fraud %', data: frauds, borderColor: '#ef4444', fill: false },
          { label: 'Flight', data: flights, borderColor: '#27e0ff', fill: false },
          { label: 'Dwell', data: dwell, borderColor: '#8affc1', fill: false },
          { label: 'Touch Speed', data: touchSpeeds, borderColor: '#ff8c69', fill: false }
        ]
      },
      options: { plugins: { legend: { labels: { color: '#fff' } } }, scales: { x: { ticks: { color: '#aaa' } }, y: { ticks: { color: '#aaa' } } } }
    });

    // Combined heatmap
    const heat = document.getElementById('combinedHeat');
    const hctx = heat.getContext('2d');
    hctx.clearRect(0,0,heat.width,heat.height);
    const clicks = [];
    user.history.slice(-50).forEach(h => { if (h.click_positions) h.click_positions.forEach(p => clicks.push(p)); });
    if (!clicks.length) { hctx.fillStyle = '#9ca3af'; hctx.fillText('No click data available in history.', 20, 30); return; }
    const buckets = {};
    clicks.slice(-5000).forEach(p => {
      const x = Math.floor((p.x / (window.innerWidth || 1)) * heat.width);
      const y = Math.floor((p.y / (window.innerHeight || 1)) * heat.height);
      const k = `${x},${y}`; buckets[k] = (buckets[k] || 0) + 1;
    });
    const max = Math.max(...Object.values(buckets));
    for (const k in buckets) {
      const [x,y] = k.split(',').map(Number);
      const intensity = buckets[k] / max;
      const radius = 8 + intensity * 30;
      hctx.beginPath();
      const grd = hctx.createRadialGradient(x,y,0,x,y,radius);
      grd.addColorStop(0, `rgba(255,0,120,${0.9 * intensity})`);
      grd.addColorStop(1, `rgba(255,0,120,0)`);
      hctx.fillStyle = grd;
      hctx.arc(x,y,radius,0,Math.PI*2);
      hctx.fill();
    }
  } catch (err) { console.error(err); }
})();
</script>
</body>
</html>