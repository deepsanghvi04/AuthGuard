<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Profile | AuthGuard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<nav class="navbar">
  <div class="nav-left">
    <div class="profile-circle" id="pc">P</div>
    <span class="site-name">AuthGuard</span>
  </div>
  <div class="nav-right">
    <a href="index.html">Home</a>
    <a href="analytics.html">Analytics</a>
    <a href="login.html" id="logoutProfile">Logout</a>
  </div>
</nav>

<section style="padding:120px 8%;">
  <h2>Your Profile</h2>
  <div id="profileArea" class="card">
    <div class="small">Loading profile...</div>
  </div>
  <div style="margin-top:12px;">
    <button class="btn" id="downloadBtn">Download Profile JSON</button>
    <button class="btn" id="deleteBtn">End Session</button>
  </div>
</section>

<script>
async function loadProfile() {
  const username = sessionStorage.getItem('authguard_user');
  if (!username) return window.location.href = 'login.html';
  document.getElementById('pc').innerText = username[0].toUpperCase();
  try {
    const res = await fetch('http://127.0.0.1:5000/profiles');
    const data = await res.json();
    const prof = data[username];
    const el = document.getElementById('profileArea');
    if (!prof) {
      el.innerHTML = `<div class="small">No profile found for <b>${username}</b>. Try Register to create one.</div>`;
      return;
    }
    el.innerHTML = `
      <h3>${username}</h3>
      <div class="small">Status: <span class="badge">${prof.status}</span></div>
      <div style="margin-top:10px;">
        <b>Flight (ms):</b> ${prof.profile.flight_mean}<br>
        <b>Dwell (ms):</b> ${prof.profile.dwell_mean}<br>
        <b>Mouse Avg (px/s):</b> ${prof.profile.mouse_mean}<br>
        <b>Touch Avg (px/s):</b> ${prof.profile.touch_mean || 0}<br>
        <b>Scroll Speed (px/s):</b> ${prof.profile.scroll_speed || 0}<br>
        <b>Fraud:</b> ${prof.fraud}%
      </div>
    `;
  } catch (err) {
    document.getElementById('profileArea').innerText = 'Failed to load profile';
  }
}
loadProfile();

document.getElementById('downloadBtn').addEventListener('click', async () => {
  const username = sessionStorage.getItem('authguard_user');
  if (!username) return;
  try {
    const res = await fetch('http://127.0.0.1:5000/admin');
    const data = await res.json();
    const blob = new Blob([JSON.stringify(data[username] || {}, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `${username}_profile.json`; a.click(); URL.revokeObjectURL(url);
  } catch (err) { alert('Download failed'); }
});

document.getElementById('deleteBtn').addEventListener('click', () => {
  sessionStorage.clear();
  window.location.href = 'login.html';
});
document.getElementById('logoutProfile').addEventListener('click', () => sessionStorage.clear());
</script>
</body>
</html>