<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Register | AuthGuard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="navbar">
  <div class="nav-left">
    <div class="profile-circle">R</div>
    <span class="site-name">AuthGuard</span>
  </div>
</nav>

<section style="padding:120px 8%;">
  <h2>Create account</h2>

  <div class="card">
    <input id="reg_username" placeholder="Username">
    <input id="reg_password" type="password" placeholder="Password">
    <div class="hint">We'll capture a short (15s) baseline of your typing, mouse/touch and scroll behavior to create your profile. This helps continuous authentication.</div>

    <div style="margin-top:12px;">
      <button class="btn" id="startBtn">Start Capture (15s)</button>
      <button class="btn" id="registerBtn" disabled>Register</button>
    </div>

    <p id="regMsg" class="hint"></p>

    <div style="margin-top:18px;">
      <input id="typing_sample" placeholder="Type here during capture..." style="display:block;">
      <div class="small">Please interact naturally while capture runs: type, move mouse / touch, scroll.</div>
    </div>
  </div>
</section>

<script>
/*
 Improved register page:
 - Collects samples for 15s
 - Sends payload to /register with password
 - Handles server errors and shows clear messages
*/
let capturing = false;
let flightSamples = [];
let dwellSamples = [];
let lastKey = 0;
let keyDownTimes = {};
let mouseSamples = [];
let clickCount = 0;
let scrollCount = 0;
let scrollSpeeds = [];
let lastScrollY = window.scrollY || 0;
let lastScrollTime = Date.now();
let touchSamples = [];

const startBtn = document.getElementById('startBtn');
const registerBtn = document.getElementById('registerBtn');
const regMsg = document.getElementById('regMsg');

startBtn.addEventListener('click', () => {
  const uname = document.getElementById('reg_username').value.trim();
  if (!uname) { regMsg.innerText = 'Please enter a username first.'; return; }

  capturing = true;
  flightSamples = []; dwellSamples = []; mouseSamples = []; clickCount = 0;
  scrollCount = 0; scrollSpeeds = []; touchSamples = [];
  regMsg.innerText = 'Capturing for 15 seconds. Interact naturally...';
  registerBtn.disabled = true;
  document.getElementById('typing_sample').focus();

  setTimeout(() => {
    capturing = false;
    regMsg.innerText = 'Capture complete. Click Register to submit your profile.';
    registerBtn.disabled = false;
  }, 15000);
});

document.getElementById('typing_sample').addEventListener('keydown', (e) => {
  if (!capturing) return;
  const now = Date.now();
  if (lastKey) flightSamples.push(now - lastKey);
  lastKey = now;
  keyDownTimes[e.code || e.key] = now;
});

document.getElementById('typing_sample').addEventListener('keyup', (e) => {
  if (!capturing) return;
  const now = Date.now();
  const down = keyDownTimes[e.code || e.key];
  if (down) dwellSamples.push(now - down);
  delete keyDownTimes[e.code || e.key];
});

document.addEventListener('mousemove', (e) => {
  if (!capturing) return;
  const speed = Math.abs(e.movementX || 0) + Math.abs(e.movementY || 0);
  mouseSamples.push(speed);
});

document.addEventListener('click', () => { if (capturing) clickCount++; });

document.addEventListener('touchmove', (e) => {
  if (!capturing) return;
  if (e.touches && e.touches[0]) touchSamples.push(1);
});

document.addEventListener('scroll', () => {
  if (!capturing) return;
  const now = Date.now();
  const y = window.scrollY || window.pageYOffset || 0;
  const dy = Math.abs(y - lastScrollY);
  const dt = Math.max(1, now - lastScrollTime);
  const sp = (dy / dt) * 1000;
  scrollSpeeds.push(sp);
  lastScrollY = y;
  lastScrollTime = now;
  scrollCount++;
});

registerBtn.addEventListener('click', async () => {
  const username = document.getElementById('reg_username').value.trim();
  const password = document.getElementById('reg_password').value;
  if (!username || !password) { regMsg.innerText = 'Username and password required.'; return; }

  registerBtn.disabled = true;
  regMsg.innerText = 'Registering...';

  const payload = {
    username,
    password,
    flight: flightSamples.slice(-500),
    dwell: dwellSamples.slice(-500),
    mouse_speed: mouseSamples.length ? (mouseSamples.reduce((a,b)=>a+b,0)/mouseSamples.length) : 0,
    clicks: clickCount,
    scrolls: scrollCount,
    scroll_speed: scrollSpeeds.length ? Math.round(scrollSpeeds.reduce((a,b)=>a+b,0)/scrollSpeeds.length) : 0,
    touch_interactions: touchSamples.length
  };

  try {
    const res = await fetch('http://127.0.0.1:5000/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (res.ok) {
      regMsg.innerText = 'Registration successful — you can login now.';
      // optionally auto-login:
      sessionStorage.setItem('authguard_user', username);
      setTimeout(() => window.location.href = 'index.html', 900);
    } else {
      regMsg.innerText = data.error || 'Registration failed. Check server logs.';
      registerBtn.disabled = false;
    }
  } catch (err) {
    regMsg.innerText = 'Network error — could not reach server. Ensure backend (python app.py) is running.';
    registerBtn.disabled = false;
    console.error('Register error:', err);
  }
});
</script>
</body>
</html>